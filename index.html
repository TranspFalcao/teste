
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demonstrativo por Unidade</title>
    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .controls { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        select, button { padding: 6px 10px; font-size: 14px; }
        .indicators { display: flex; gap: 20px; margin-bottom: 15px; }
        .indicator { flex: 1; padding: 10px; font-size: 16px; font-weight: bold; color: #fff; text-align: center; border-radius: 4px; }
        .debit { background-color: #c0392b; }
        .credit { background-color: #27ae60; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f4f4f4; }
        .negative { color: red; }
        .chart-container { width: 90%; margin: 30px auto; }
    </style>
</head>
<body>
    <h1>Demonstrativo por Unidade</h1>
    <input type="file" id="upload" accept=".xls,.xlsx" />

    <div class="controls">
        <label>UF: <select id="filterUF"></select></label>
        <label>Ano: <select id="filterAno"></select></label>
        <label>Tipo: <select id="filterTipo"></select></label>
        <label>Aba Consolidado: <select id="sheetConsolidado"></select></label>
        <label>Aba Detalhado: <select id="sheetDetalhado"></select></label>
        <button onclick="exportExcel()">Exportar Excel</button>
        <button onclick="exportPDF()">Exportar PDF</button>
    </div>

    <div class="indicators">
        <div class="indicator debit">Total Débito: R$ <span id="totalDebito">0,00</span></div>
        <div class="indicator credit">Total Crédito: R$ <span id="totalCredito">0,00</span></div>
    </div>

    <div id="table-container"></div>

    <div class="chart-container">
        <canvas id="chartUF"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="chartMes"></canvas>
    </div>

    <script>
        let aba2Data = [];
        let workbook;

        document.getElementById('upload').addEventListener('change', handleFile);

        function handleFile(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const data = new Uint8Array(event.target.result);
                workbook = XLSX.read(data, { type: 'array' });

                const sheetNames = workbook.SheetNames;
                fillSelect('sheetConsolidado', sheetNames);
                fillSelect('sheetDetalhado', sheetNames);
            };
            reader.readAsArrayBuffer(file);
        }

        document.getElementById('sheetConsolidado').addEventListener('change', loadSheets);
        document.getElementById('sheetDetalhado').addEventListener('change', loadSheets);

        function loadSheets() {
            const consolidado = document.getElementById('sheetConsolidado').value;
            const detalhado = document.getElementById('sheetDetalhado').value;
            if(consolidado && detalhado) {
                const aba6 = XLSX.utils.sheet_to_json(workbook.Sheets[consolidado], { header: 1 });
                aba2Data = XLSX.utils.sheet_to_json(workbook.Sheets[detalhado]);

                populateFilters(aba2Data);
                calculateIndicators(aba2Data);
                renderTable(aba6);
                renderCharts(aba6);
            }
        }

        function fillSelect(id, items) {
            const select = document.getElementById(id);
            select.innerHTML = '<option value="">Selecione</option>';
            items.forEach(val => {
                select.innerHTML += `<option value="${val}">${val}</option>`;
            });
        }

        function populateFilters(data) {
            const ufSet = new Set();
            const anoSet = new Set();
            const tipoSet = new Set();

            data.forEach(row => {
                if(row.UF) ufSet.add(row.UF);
                if(row.ANO) anoSet.add(row.ANO);
                if(row.TIPO) tipoSet.add(row.TIPO);
            });

            fillSelect('filterUF', Array.from(ufSet));
            fillSelect('filterAno', Array.from(anoSet));
            fillSelect('filterTipo', Array.from(tipoSet));
        }

        function calculateIndicators(data) {
            let totalDebito = 0;
            let totalCredito = 0;
            data.forEach(row => {
                const valor = parseFloat(row.VALOR) || 0;
                if(row.TIPO && row.TIPO.toLowerCase().includes('débito')) totalDebito += valor;
                if(row.TIPO && row.TIPO.toLowerCase().includes('crédito')) totalCredito += valor;
            });
            document.getElementById('totalDebito').textContent = totalDebito.toLocaleString('pt-BR');
            document.getElementById('totalCredito').textContent = totalCredito.toLocaleString('pt-BR');
        }

        function renderTable(data) {
            let html = '<table><thead><tr>';
            html += data[5].map(h => `<th>${h}</th>`).join('');
            html += '</tr></thead><tbody>';

            for (let i = 6; i < data.length; i++) {
                if (data[i].length > 1 && data[i][1]) {
                    html += '<tr>' + data[i].map((v, idx) => {
                        const cls = (parseFloat(v) < 0 && idx > 1) ? 'negative' : '';
                        return `<td class="${cls}">${v || ''}</td>`;
                    }).join('') + '</tr>';
                }
            }
            html += '</tbody></table>';
            document.getElementById('table-container').innerHTML = html;
        }

        function renderCharts(data) {
            const meses = data[5].slice(2, 12);
            const ufLabels = [];
            const ufTotals = [];
            const mesTotals = Array(meses.length).fill(0);

            for (let i = 6; i < data.length; i++) {
                if (data[i][1] && data[i][1] !== 'Saldo Final') {
                    ufLabels.push(data[i][1]);
                    let totalUF = 0;
                    for (let j = 2; j < 12; j++) {
                        const val = parseFloat(data[i][j]) || 0;
                        totalUF += val;
                        mesTotals[j-2] += val;
                    }
                    ufTotals.push(totalUF);
                }
            }

            new Chart(document.getElementById('chartUF'), {
                type: 'bar',
                data: { labels: ufLabels, datasets: [{ label: 'Total por UF', data: ufTotals, backgroundColor: 'rgba(54,162,235,0.6)' }] },
                options: { responsive: true, plugins: { title: { display: true, text: 'Totais por UF' } } }
            });

            new Chart(document.getElementById('chartMes'), {
                type: 'line',
                data: { labels: meses, datasets: [{ label: 'Total por Mês', data: mesTotals, borderColor: 'rgba(75,192,192,0.8)', fill: false }] },
                options: { responsive: true, plugins: { title: { display: true, text: 'Totais por Mês' } } }
            });
        }

        function exportExcel() {
            const ws = XLSX.utils.json_to_sheet(aba2Data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Dados Filtrados');
            XLSX.writeFile(wb, 'dados_filtrados.xlsx');
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Relatório de Dados Filtrados', 10, 10);
            let y = 20;
            aba2Data.slice(0, 50).forEach(row => {
                doc.text(JSON.stringify(row), 10, y);
                y += 10;
            });
            doc.save('dados_filtrados.pdf');
        }
    </script>
</body>
</html>
