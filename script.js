let allData=[];let chartInstance=null;document.addEventListener('DOMContentLoaded',()=>{Papa.parse('https://transpfalcao.github.io/teste/Impostos.csv',{download:true,header:true,delimiter:';',skipEmptyLines:true,complete:function(results){allData=results.data.filter(r=>r.UNIDADE&&r.ANO&&r.MES);populateFilters();updateTableAndChart();}});document.getElementById('filterUnidade').addEventListener('change',updateTableAndChart);document.getElementById('filterAno').addEventListener('change',updateTableAndChart);document.getElementById('filterMes').addEventListener('change',updateTableAndChart);document.getElementById('filterTipo').addEventListener('change',updateTableAndChart);document.getElementById('btnPDF').addEventListener('click',generatePDF);function populateFilters(){const unidades=[...new Set(allData.map(d=>d.UNIDADE))].sort();const anos=[...new Set(allData.map(d=>d.ANO))].sort();const meses=[...new Set(allData.map(d=>d.MES))];document.getElementById('filterUnidade').innerHTML='<option value="">Todas</option>'+unidades.map(u=>`<option value="${u}">${u}</option>`).join('');document.getElementById('filterAno').innerHTML='<option value="">Todos</option>'+anos.map(a=>`<option value="${a}">${a}</option>`).join('');document.getElementById('filterMes').innerHTML='<option value="">Todos</option>'+meses.map(m=>`<option value="${m}">${m}</option>`).join('');}function updateTableAndChart(){const unidade=document.getElementById('filterUnidade').value;const ano=document.getElementById('filterAno').value;const mes=document.getElementById('filterMes').value;const tipo=document.getElementById('filterTipo').value;const filtered=allData.filter(d=>(unidade==''||d.UNIDADE===unidade)&&(ano==''||d.ANO===ano)&&(mes==''||d.MES===mes)&&(tipo==''||d.TIPO===tipo));const tbody=document.querySelector('#dataTable tbody');tbody.innerHTML=filtered.map(d=>`<tr><td>${d.UNIDADE}</td><td>${d.UF}</td><td>${d.MES}</td><td>${d.ANO}</td><td class="${d.TIPO==='Credito'?'credito':'debito'}">${d.TIPO}</td><td>${new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(parseFloat(d.VALOR))}</td></tr>`).join('');const labels=filtered.map(d=>`${d.MES}/${d.ANO}`);const valores=filtered.map(d=>parseFloat(d.VALOR||0));const ctx=document.getElementById('chart').getContext('2d');if(chartInstance)chartInstance.destroy();chartInstance=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Valores',data:valores,backgroundColor:'rgba(54,162,235,0.6)'}]},options:{responsive:true}});}async function generatePDF(){const{jsPDF}=window.jspdf;const pdf=new jsPDF('p','mm','a4');const content=document.querySelector('.container');await html2canvas(content,{scale:2}).then(canvas=>{const imgData=canvas.toDataURL('image/png');pdf.addImage(imgData,'PNG',10,10,190,0);pdf.save('demonstrativo.pdf');});}